<!DOCTYPE html>
<html>
	<head>
		<title>three.terraingen.js</title>
		<style type="text/css">
			
			html, body {
				padding:0;
				margin:0;
				overflow:hidden;
			}
			
			#heightMap {
				position:absolute;
				top:10px;
				left:10px;
			}
			
			#controls {
				position:absolute;
				right:10px;
				top:10px;
				padding:20px;
				background:rgba(255,255,255,0.7);
				z-index:100;
			}
		</style>
	</head>
	
	<body>
		<div id="controls">
			<label>Seed</label>
			<input type="text" id="seed" value="545437820543">
			<br>
			<label>X</label>
			<input type="range" id="pos_x" min="0" max="10000" value="0">
			<label>Y</label>
			<input type="range" id="pos_y" min="0" max="10000" value="0">
		</div>
		
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/three.js/r68/three.js"></script>
		<script type="text/javascript" src="../dist/libs/catiline.js"></script>
		<script type="text/javascript" src="../dist/RNGProvider.js"></script>
		<script type="text/javascript" src="../dist/NoiseProvider.js"></script>
		<script type="text/javascript" src="../dist/NoiseModifierProvider.js"></script>
		<script type="text/javascript" src="../dist/HeightMapProvider.js"></script>
		<script type="text/javascript" src="../dist/GeometryProvider.js"></script>
		<script type="text/javascript" src="../dist/MeshProvider.js"></script>
		<script type="text/javascript" src="../dist/PatchProvider.js"></script>
		<script type="text/javascript" src="../dist/FilterProvider.js"></script>
		<script type="text/javascript" src="ThreadedThings.js"></script>
		<script type="text/javascript" src="TrackBallControls.js"></script>
		<script type="text/javascript" src="OrbitControls.js"></script>
		
		<script type="text/javascript">
		
			//NoiseGenerator.Seed = 523542354534543;
			
			NoiseGenerator.initRandom(33);
			
			
			
			
			
			var noiseFunction = new THREE.terraingen.modifiers.Multiply (
				new THREE.terraingen.modifiers.Mix (
					new THREE.terraingen.generators.Perlin (
						new THREE.terraingen.MersenneTwisterProvider(1222).random, 12, 0.0001
					),
					new THREE.terraingen.modifiers.Abs (
						new THREE.terraingen.generators.Perlin (
							new THREE.terraingen.MersenneTwisterProvider(2349243).random, 12, 0.0008
						)
					),
					new THREE.terraingen.generators.Perlin (
						new THREE.terraingen.MersenneTwisterProvider(32432432).random, 8, 0.001
					)
				
				),
				
				new THREE.terraingen.modifiers.Constant(0.8)
			)
			
			NoiseGenerator.noiseGenerator = noiseFunction;
			
			workers = cw(NoiseGenerator, 4);
			
			var NOISE_SIZE = 256;
			var NUM_TILES = 4;
			
			function renderCanvas (noiseResult, x, y) {
				
				
				var canvas = document.createElement('canvas');
				canvas.height = NOISE_SIZE;
		 		canvas.width = NOISE_SIZE;
		 		
		 		canvas.style.position = "absolute";
		 		canvas.style.top = y + "px";
		 		canvas.style.left = x + "px";
		 		
		 		document.body.appendChild(canvas);
		 		
		 		
		 		
		 		var ctx = canvas.getContext('2d')
		 		var id = ctx.createImageData(1,1);
		 		var d = id.data;
		 		
		 		
		 		for (var i = 0; i < NOISE_SIZE; i++) {
		 			for (var j = 0; j < NOISE_SIZE; j++) {
		 				
		 				var hgt = noiseResult[ i*NOISE_SIZE + j ]
		 				h = hgt + 1.0 * 0.5;
		 				var pix = Math.min(255, Math.max(0, Math.floor( (1.0-h) * 256 )));
		 				d[0] = d[1] = d[2] = pix;
		 				d[3] = 255;
		 				ctx.putImageData(id, i, j);
		 			}
		 		}
		 		
		 		
			}
			
			
			var queue = [];
			
			function doIt (posx, posy) {
				
				
				var px = posx;
				var py = posy;
				
				
				var canvases = document.getElementsByTagName('canvas');
				
				for (var i=0; i<canvases.length; i++) {
					document.body.removeChild(canvases[i]);
				}
				
				for (var i=0; i<NUM_TILES; i++ ) {
					for (var j=0; j<NUM_TILES; j++) {
						var params = {
							
							x_screen: i*NOISE_SIZE,
							y_screen: j*NOISE_SIZE,
							
							x:posx + (i*NOISE_SIZE), 
							y:posy + (j*NOISE_SIZE), 
							width:NOISE_SIZE, 
							height:NOISE_SIZE, 
							octaves:10, 
							scale:1.0, 
							seed:424324,
							container: new Float32Array( NOISE_SIZE * NOISE_SIZE )
						}
						workers.getRegion(params).then(
							function (data) {
								queue.push( data )
							}, 
							function (err) {
								console.log(err)
							}
						);
					}
				}
			}
			
			
			
			function update () {
				requestAnimationFrame(update);
				if (queue.length) {
					var d = queue.pop();
					renderCanvas( d.container, d.x_screen, d.y_screen )
				}
			}
			
			var inptX = document.getElementById('pos_x');
			var inptY = document.getElementById('pos_y');
			
			var btn = document.getElementById('btn_go');
			
			inptX.onchange = inptY.onchange = function () {
				var _x = parseInt ( inptX.value );
				var _y = parseInt ( inptY.value );
				doIt(_x,_y);
			}
			
			
			
			/*inpt.onkeyup = function () {
				var scale = getScale(scaleinpt.value)
				doIt(this.value, scale);
			}*/
			
			
			/*scaleinpt.onchange = function () {
				var seed = inpt.value
				doIt( seed, getScale( this.value ));
			}*/
			
			update();
			
			// test vertices
			
			var config = {
				type : "Mix",
				sources : [
					{
						type: "Perlin",
						sources: [
							{
								type:"MT",
								seed:748237932,
							}
						]
					},
					{
						
					}
				]
			};
			
			
			
			var prams = {
				bounds: new THREE.Box2( new THREE.Vector2( 0, 0 ), new THREE.Vector2( 128, 128 ) ),
				segments: 33,
				octaves:12,
				scale:0.005,
				seed:623424322,
				vertices: new Float32Array ( 33 * 33 * 3 )
			}
			
			workers.getVertices(prams).then( function (data) {
				console.log(data.vertices);
			});
			
			
			
			
		</script>
		
		
	</body>
</html>